# Flask REST API с PostgreSQL

Простое Flask приложение с JSON REST API и PostgreSQL в качестве хранилища данных.

OpenAPI спецификация взята по [ссылке](https://github.com/OtusTeam/highload/blob/d952f8bf71cb979f30e1657f37713ddd33b4451d/homework/openapi.json).

## Требования

- Docker
- Docker Compose

## Запуск

1. Клонируйте репозиторий
2. Запустите приложение с помощью Docker Compose:

```bash
docker-compose up --build
```

Приложение будет доступно по адресу `http://localhost:8000`

### Логика запуска

Приложение автоматически:
1. **Ждет готовности PostgreSQL** (healthcheck)
2. **Запускает миграции** Alembic
3. **Запускает Flask сервер**

При неудачном запуске сервис получает **3 попытки перезапуска** (`restart: on-failure:3`).

## API Endpoints

### POST /login
Принимает JSON с атрибутами `id` и `password`, возвращает JSON с полем `token`.

**Пример запроса:**
```json
{
  "id": "user123",
  "password": "password123"
}
```

**Пример ответа:**
```json
{
  "token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..."
}
```

### GET /health
Проверка состояния сервиса.

## Архитектура приложения

Приложение построено по принципу **разделения ответственности** с четким разделением на три основных модуля:

### Принцип разделения на модули

Код приложения структурирован согласно принципам чистой архитектуры:

- **`infra/`** - инфраструктурный слой
  - **`infra/db/`** - работа с базой данных (модели, миграции, конфигурация)
  - **`infra/rest/`** - веб-сервисы (REST API, middleware, обработчики ошибок)
  - **`infra/logging/`** - система логирования

- **`app/`** - слой приложения (увязывает инфраструктуру с бизнес-логикой)
  - Модули `infra` вызывают модули `app`
  - Модули `app` вызывают модули `infra`
  - Получают ссылки на экземпляры классов из модулей `model` и отправляют им команды

- **`model/`** - слой бизнес-логики (планируется)
  - Модули бизнес-логики
  - Доменные модели и сервисы

### Направление зависимостей между слоями

Зависимости между слоями направлены следующим образом: **infra → app → model**

- **`infra`** может ссылаться на модули `app` и `model`
- **`app`** может ссылаться на модули `model`, но **не может** ссылаться на модули `infra`
- **`model`** **не может** ссылаться на модули никакого другого слоя

Это обеспечивает:
- **Инверсию зависимостей** - инфраструктура зависит от бизнес-логики, а не наоборот
- **Независимость бизнес-логики** - модель не знает о деталях реализации
- **Гибкость** - можно легко заменить инфраструктурные компоненты

## Структура проекта

- `app.py` - основной файл Flask приложения (минимальный, только инициализация)
- `init_app.py` - скрипт инициализации (миграции + запуск приложения)
- `infra/` - инфраструктурные модули
  - `db/` - база данных (модели, миграции, конфигурация)
  - `rest/` - веб-сервисы (API, middleware, обработчики)
  - `logging/` - система логирования
- `requirements.txt` - зависимости Python
- `Dockerfile` - конфигурация Docker для приложения
- `docker-compose.yml` - конфигурация Docker Compose
- `README.md` - документация

## База данных

PostgreSQL запускается на порту 5432 с следующими параметрами:
- База данных: `app_db`
- Пользователь: `postgres`
- Пароль: `password`

### Миграции

Проект использует **Alembic** для управления миграциями базы данных.

**Создание новой миграции:**
```bash
alembic revision -m "Описание миграции"
```

**Создание миграции с автогенерацией (требует подключения к БД):**
```bash
alembic revision --autogenerate -m "Описание миграции"
```

**Применение миграций:**
```bash
alembic upgrade head
```

**Откат миграций:**
```bash
alembic downgrade -1  # откат на одну миграцию назад
```

**Запуск миграций через скрипт:**
```bash
python infra/db/run_migrations.py
```

## Тестирование

Проект использует **pytest** для unit тестирования.

### Запуск тестов

**Запуск всех тестов:**
```bash
pytest
```

**Запуск с подробным выводом:**
```bash
pytest -v
```

**Запуск конкретного тестового файла:**
```bash
pytest tests/test_basic.py
```

**Запуск конкретного теста:**
```bash
pytest tests/test_basic.py::test_basic_math
```

**Запуск тестов с покрытием кода (требует pytest-cov):**
```bash
pytest --cov=app tests/
```

### Структура тестов

- `tests/` - папка с тестами
- `pytest.ini` - конфигурация pytest

### Написание тестов

Тесты должны:
- Начинаться с `test_` в имени функции
- Находиться в файлах, начинающихся с `test_`
- Использовать `assert` для проверок
- Быть независимыми друг от друга