# Flask REST API с PostgreSQL

Простое Flask приложение с JSON REST API и PostgreSQL в качестве хранилища данных.

OpenAPI спецификация взята по [ссылке](https://github.com/OtusTeam/highload/blob/d952f8bf71cb979f30e1657f37713ddd33b4451d/homework/openapi.json).

## Требования

- Docker
- Docker Compose

## Запуск

1. Клонируйте репозиторий
2. Запустите приложение с помощью Docker Compose:

```bash
docker-compose up --build
```

Приложение будет доступно по адресу `http://localhost:8000`

### Логика запуска

Docker compose файл и приложению обеспечивают последовательно:
1. Ожидание готовности PostgreSQL
2. Запуск миграции Alembic
3. Запуск Flask сервера

При неудачном запуске сервис получает **3 попытки перезапуска** (`restart: on-failure:3`).

## API Endpoints

Описание посредством спецификации [openapi.json](infra/rest/spec/openapi.json).

## Архитектура приложения

Приложение построено по принципу **разделения ответственности** с четким разделением на три основных модуля:

### Принцип разделения на модули

Код приложения структурирован согласно принципам чистой архитектуры:

- **`infra/`** - инфраструктурный слой
  - **`infra/db/`** - работа с базой данных (модели, миграции, конфигурация)
  - **`infra/rest/`** - веб-сервисы (REST API, middleware, обработчики ошибок)
  - **`infra/logging/`** - система логирования

- **`application/`** - слой приложения (увязывает инфраструктуру с бизнес-логикой)
  - Модули `infra` вызывают модули `application`
  - Модули `application` вызывают модули `infra`
  - Получают ссылки на экземпляры классов из модулей `model` и отправляют им команды

- **`model/`** - слой бизнес-логики
  - Модули бизнес-логики
  - Доменные модели и сервисы

### Направление зависимостей между слоями

Зависимости между слоями направлены следующим образом: **infra → application → model**

- **`infra`** может ссылаться на модули `application` и `model`
- **`application`** может ссылаться на модули `model`, но **не может** ссылаться на модули `infra`
- **`model`** **не может** ссылаться на модули никакого другого слоя

Это обеспечивает:
- **Инверсию зависимостей** - инфраструктура зависит от бизнес-логики, а не наоборот
- **Независимость бизнес-логики** - модель не знает о деталях реализации
- **Гибкость** - можно легко заменить инфраструктурные компоненты

## Структура проекта

- `init_app.py` - входная точка в приложение: миграция БД и затем запуск сервера
- `app.py` - основной файл Flask приложения
- `application/` - слой приложения
- `infra/` - инфраструктурные модули
  - `db/` - база данных
  - `rest/` - веб-сервисы
  - `logging/` - система логирования
- `model/` - слой бизнес-логики
- `tests/` - тесты приложения
- `requirements.txt` - зависимости Python
- `Dockerfile` - конфигурация Docker
- `docker-compose.yml` - конфигурация Docker Compose
- `pytest.ini` - конфигурация тестирования
- `README.md` - документация

## База данных

PostgreSQL запускается на порту 5432 с следующими параметрами:
- База данных: `app_db`
- Пользователь: `postgres`
- Пароль: `password`

### Миграции

Проект использует **Alembic** для управления миграциями базы данных.

**Создание новой миграции:**
```bash
alembic revision -m "Описание миграции"
```

**Создание миграции с автогенерацией (требует подключения к БД):**
```bash
alembic revision --autogenerate -m "Описание миграции"
```

**Применение миграций:**
```bash
alembic upgrade head
```

**Откат миграций:**
```bash
alembic downgrade -1  # откат на одну миграцию назад
```

**Запуск миграций через скрипт:**
```bash
python infra/db/run_migrations.py
```

## Тестирование

Проект использует **pytest** для unit тестирования.

### Запуск тестов

**Запуск всех тестов:**
```bash
pytest
```

**Запуск с подробным выводом:**
```bash
pytest -v
```

**Запуск конкретного тестового файла:**
```bash
pytest tests/test_basic.py
```

**Запуск конкретного теста:**
```bash
pytest tests/test_basic.py::test_basic_math
```

**Запуск тестов с покрытием кода (требует pytest-cov):**
```bash
pytest --cov=application tests/
```

### Структура тестов

- `tests/` - папка с тестами
- `pytest.ini` - конфигурация pytest

### Написание тестов

Тесты должны:
- Начинаться с `test_` в имени функции
- Находиться в файлах, начинающихся с `test_`
- Использовать `assert` для проверок
- Быть независимыми друг от друга

## Dependency Injection

В проекте используется библиотека [injector](https://pypi.org/project/injector/) для внедрения зависимостей.